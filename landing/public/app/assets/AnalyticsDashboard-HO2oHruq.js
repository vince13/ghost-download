import{c as $,r as j,g as q,d as G,q as _,w as E,T as C,o as k,l as L,e as z,j as e,A as U,f as g,M as B,B as w,Z as F,h as H}from"./index-zowQoAB2.js";import{C as O}from"./chart-column-Bw2vaWZo.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=$("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=$("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),Z=({userId:y,enabled:v=!0,dateRange:b=30})=>{const[c,D]=j.useState([]),[r,p]=j.useState(!1),[A,N]=j.useState(null);j.useEffect(()=>{if(!v||!y){D([]),p(!1);return}(async()=>{p(!0),N(null);try{const d=q();if(!d){p(!1);return}const h=G(d,"users",y,"analytics"),x=new Date;x.setDate(x.getDate()-b),x.setHours(0,0,0,0);let m;try{m=_(h,E("timestamp",">=",C.fromDate(x)),k("timestamp","desc"),L(1e3))}catch(n){try{console.warn("[useAnalyticsData] Timestamp index not found, trying createdAt:",n),m=_(h,E("createdAt",">=",C.fromDate(x)),k("createdAt","desc"),L(1e3))}catch(i){console.warn("[useAnalyticsData] Index not available, using simple query:",i),m=_(h,k("timestamp","desc"),L(1e3))}}const a=(await z(m)).docs.map(n=>{var o,T,s,l;const i=n.data(),u=((T=(o=i.timestamp)==null?void 0:o.toDate)==null?void 0:T.call(o))||((l=(s=i.createdAt)==null?void 0:s.toDate)==null?void 0:l.call(s))||(i.timestamp instanceof C?i.timestamp.toDate():null)||(i.createdAt instanceof C?i.createdAt.toDate():null)||new Date;return{id:n.id,...i,timestamp:u}}).filter(n=>{const i=n.timestamp,u=new Date;return u.setDate(u.getDate()-b),u.setHours(0,0,0,0),i>=u});D(a)}catch(d){console.error("[useAnalyticsData] Error fetching analytics:",d),N(d.message)}finally{p(!1)}})()},[y,v,b]);const S=j.useMemo(()=>{const M=c.filter(s=>s.eventType==="session_start"),d=c.filter(s=>s.eventType==="session_metrics"),h=c.filter(s=>s.eventType==="cue_generated"),x=c.filter(s=>s.eventType==="feature_used"),m=c.filter(s=>s.eventType==="vapi_call_start"),t=M.length,a=h.reduce((s,l)=>s+(l.newCues||1),0),n=d.reduce((s,l)=>s+(l.duration||0),0),i=t>0?Math.round(n/t):0,u=x.reduce((s,l)=>{const f=`${l.feature}_${l.action}`;return s[f]=(s[f]||0)+1,s},{}),o={};return Array.from({length:7},(s,l)=>{const f=new Date;return f.setDate(f.getDate()-l),f.toDateString()}).forEach(s=>{o[s]={sessions:0,cues:0,features:0}}),c.forEach(s=>{const l=s.timestamp.toDateString();o[l]&&(s.eventType==="session_start"?o[l].sessions++:s.eventType==="cue_generated"?o[l].cues+=s.newCues||1:s.eventType==="feature_used"&&o[l].features++)}),{totalSessions:t,totalCues:a,totalDuration:n,avgSessionDuration:i,totalVapiCalls:m.length,featureUsage:u,dailyActivity:Object.entries(o).reverse(),sessionMetrics:d.map(s=>({duration:s.duration||0,cuesGenerated:s.cuesGenerated||0,transcriptLines:s.transcriptLines||0,mode:s.mode||"unknown",hasVapiCall:s.hasVapiCall||!1}))}},[c]);return{events:c,metrics:S,isLoading:r,error:A}},K=({userId:y,isOpen:v,onClose:b})=>{var h,x,m;const[c,D]=j.useState(30),{metrics:r,isLoading:p,error:A}=Z({userId:y,enabled:v&&!!y,dateRange:c});if(!v)return null;const N=t=>{if(t<60)return`${t}s`;const a=Math.floor(t/60),n=t%60;return`${a}m ${n}s`},S=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric"}),M=Math.max(...((h=r.dailyActivity)==null?void 0:h.map(([t,a])=>a.sessions))||[0],1),d=Math.max(...((x=r.dailyActivity)==null?void 0:x.map(([t,a])=>a.cues))||[0],1);return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col m-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(O,{className:"w-6 h-6 text-blue-400"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-100",children:"Analytics Dashboard"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("select",{value:c,onChange:t=>D(Number(t.target.value)),className:"px-3 py-1.5 rounded-lg border border-gray-700 bg-gray-800 text-gray-200 text-sm",children:[e.jsx("option",{value:7,children:"Last 7 days"}),e.jsx("option",{value:30,children:"Last 30 days"}),e.jsx("option",{value:90,children:"Last 90 days"})]}),e.jsx("button",{onClick:b,className:"p-2 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition-colors",children:"âœ•"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:p?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(U,{className:"w-12 h-12 mx-auto mb-4 animate-spin"}),e.jsx("p",{children:"Loading analytics..."})]}):A?e.jsx("div",{className:"text-center py-12 text-red-400",children:e.jsxs("p",{children:["Error loading analytics: ",A]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(g,{className:"p-4 bg-gradient-to-br from-blue-900/20 to-blue-950/10 border-blue-800/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(B,{className:"w-5 h-5 text-blue-400"}),e.jsx(w,{color:"blue",className:"text-xs",children:"Sessions"})]}),e.jsx("div",{className:"text-3xl font-bold text-gray-100",children:r.totalSessions}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Total sessions"})]}),e.jsxs(g,{className:"p-4 bg-gradient-to-br from-yellow-900/20 to-yellow-950/10 border-yellow-800/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(F,{className:"w-5 h-5 text-yellow-400"}),e.jsx(w,{color:"yellow",className:"text-xs",children:"Cues"})]}),e.jsx("div",{className:"text-3xl font-bold text-gray-100",children:r.totalCues}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Coaching cues generated"})]}),e.jsxs(g,{className:"p-4 bg-gradient-to-br from-green-900/20 to-green-950/10 border-green-800/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(H,{className:"w-5 h-5 text-green-400"}),e.jsx(w,{color:"green",className:"text-xs",children:"Duration"})]}),e.jsx("div",{className:"text-3xl font-bold text-gray-100",children:N(r.avgSessionDuration)}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Avg session duration"})]}),e.jsxs(g,{className:"p-4 bg-gradient-to-br from-purple-900/20 to-purple-950/10 border-purple-800/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(V,{className:"w-5 h-5 text-purple-400"}),e.jsx(w,{color:"purple",className:"text-xs",children:"Vapi"})]}),e.jsx("div",{className:"text-3xl font-bold text-gray-100",children:r.totalVapiCalls}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Vapi calls"})]})]}),e.jsxs(g,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5 text-blue-400"}),"Daily Activity (Last 7 Days)"]}),e.jsx("div",{className:"space-y-3",children:(m=r.dailyActivity)==null?void 0:m.map(([t,a])=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:S(t)}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500",children:[e.jsxs("span",{children:[a.sessions," sessions"]}),e.jsxs("span",{children:[a.cues," cues"]}),e.jsxs("span",{children:[a.features," features"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-6 bg-gray-800 rounded overflow-hidden relative",children:e.jsx("div",{className:"h-full bg-blue-500/60 flex items-center justify-end pr-2",style:{width:`${a.sessions/M*100}%`},children:a.sessions>0&&e.jsx("span",{className:"text-[10px] text-white font-bold",children:a.sessions})})}),e.jsx("div",{className:"flex-1 h-6 bg-gray-800 rounded overflow-hidden relative",children:e.jsx("div",{className:"h-full bg-yellow-500/60 flex items-center justify-end pr-2",style:{width:`${a.cues/d*100}%`},children:a.cues>0&&e.jsx("span",{className:"text-[10px] text-white font-bold",children:a.cues})})})]})]},t))})]}),e.jsxs(g,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-green-400"}),"Feature Usage"]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[Object.entries(r.featureUsage||{}).map(([t,a])=>{const[n,i]=t.split("_");return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-gray-800/50 border border-gray-700",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-200 capitalize",children:n.replace("_"," ")}),e.jsx("div",{className:"text-xs text-gray-400 capitalize",children:i})]}),e.jsx(w,{color:"blue",className:"text-sm",children:a})]},t)}),Object.keys(r.featureUsage||{}).length===0&&e.jsx("div",{className:"col-span-2 text-center py-8 text-gray-500 text-sm",children:"No feature usage data yet"})]})]}),r.sessionMetrics.length>0&&e.jsxs(g,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-100 mb-4 flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5 text-purple-400"}),"Session Statistics"]}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 mb-1",children:"Avg Duration"}),e.jsx("div",{className:"text-lg font-bold text-gray-100",children:N(Math.round(r.sessionMetrics.reduce((t,a)=>t+a.duration,0)/r.sessionMetrics.length))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 mb-1",children:"Avg Cues/Session"}),e.jsx("div",{className:"text-lg font-bold text-gray-100",children:Math.round(r.sessionMetrics.reduce((t,a)=>t+a.cuesGenerated,0)/r.sessionMetrics.length)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 mb-1",children:"Avg Transcript Lines"}),e.jsx("div",{className:"text-lg font-bold text-gray-100",children:Math.round(r.sessionMetrics.reduce((t,a)=>t+a.transcriptLines,0)/r.sessionMetrics.length)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 mb-1",children:"Vapi Usage"}),e.jsxs("div",{className:"text-lg font-bold text-gray-100",children:[Math.round(r.sessionMetrics.filter(t=>t.hasVapiCall).length/r.sessionMetrics.length*100),"%"]})]})]})})]})]})})]})})};export{K as AnalyticsDashboard};
